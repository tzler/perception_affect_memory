<!DOCTYPE html>

<html>
  <head>
    <title>Auditory experiment</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    /* EXPERIMENTAL PARAMETERS */ 
    var bonus_amount = 0.02
    var generalization_data = { stage: 'generalization', correct_response: 'space', valence: ''}
    var surround = [-100, -60, -20, -5, 5, 20, 60, 100] 
    var stimulus_folder = "sound/"    
    var generalization_stimuli = [] 
    var valence_tones = [300, 700] 
    var response_keys = ['p', 'q']
    var valence_types = ['positive', 'negative']
    var neutral_tones = [500] 
    var acquisition_trial_duration = 2500    
    var acquiaition_cycle = 5

    /* GENERATE DATA FILE FOR GENERALIZATION STAGE */
    for (i_valence=0;i_valence<valence_tones.length;i_valence++){ 
      /* ADD VALENCE TONES */ 
      generalization_stimuli.push({stimulus: stimulus_folder+ (valence_tones[i_valence]),
                                   data:{stage:'generalization', 
                                         correct_response:response_keys[i_valence], 
                                         valence: valence_types[i_valence]}})
      /* ADD SURROUND TONES */ 
      for (i_gen=0;i_gen<surround.length;i_gen++){ 
        generalization_stimuli.push({stimulus:stimulus_folder+ (valence_tones[i_valence] + surround[i_gen]), 
                                     data:generalization_data}) }}
 
    /* GENERATE DATA FILE FOR THE ACQUISITION STAGE */
    var acquisition_stimuli = [
      { stimulus: stimulus_folder + valence_tones[0], 
            data: { stage: 'acquisition', correct_response: 'p', valence: 'positive'} },
      { stimulus: stimulus_folder + valence_tones[1], 
            data: { stage: 'acquisition', correct_response: 'q', valence: 'negative'} },
      { stimulus: stimulus_folder + neutral_tones[0], 
            data: { stage: 'acquisition', correct_response: 'space', valence: 'neutral' } },
    ];
    
    /* GENERATE AUDIO FILE FOR PRELOADING */
    var audio = [] 
    for (i=0;i<generalization_stimuli.length;i++)
      { audio.push(generalization_stimuli[i]['stimulus'])}
    for (i=0;i<acquisition_stimuli.length;i++)
      { audio.push(acquisition_stimuli[i]['stimulus'])}

    var instructions = {
      type: "html-button-response",
      stimulus: 
			"<div style='width:70%;transform:translateX(20%)'>" +
        "<p style='font-size:200%; font-weight:bold'>Welcome to our experiment!</p>" +
          "<p style='font-size:140%'>In this study your goal is to learn how best to respond to different sounds.</p>" +
        	"You'll hear three sounds; you'll have to respond differently to each. " + 
          "For one sound, you'll be <b>rewarded when you press the correct key</b>. " +
        	"For another sound, you'll be <b>penalized when you press any incorrect key</b>. " +
        	"For the last sound, <b>there's no reward or punishment</b>--it doesn't matter what you press. " +
        	"The amount of your reward or penalty will be displayed after each choice you make, " +
        	"(e.g. +$" + bonus_amount + ", -$" + bonus_amount + ", or $0.00), " +
          "so you'll learn by paying attention to the feedback you get after each key press you make. " +
          "<br><br>The three keys you can press throughout the experiment are '<b>p</b>', '<b>q</b>', and '<b>spacebar</b>'. " +
        	"These are the only three keys that will register any response, so remember them. " +
          "The faster you learn, the more bonus you'll be able to earn!" +  
      	"<p>" +
      "<div>", 
      post_trial_gap: 400, 
      choices: ["<p style='margin: 10px'>I'm ready to start!</p>"]
    };

    var generalization_instructions = {
      type: "html-button-response",
      stimulus: "<div style='width:70%;transform:translateX(20%)'>" + 
      "<p>" + 
        "<p style='font-size:140%'>Now the experiment is going to change just a bit.</p>" + 
        "We'll play a sound, and you'll have to decide if it was among the first three sounds you heard. " + 
        "If it was, you should press the key that sound was associated with." + 
      "If the sound you hear is a new sound, not the three you heard you'll press the '<b>6</b>' key. " + 
        "Your task will be to determine whether the sound you're hearing was among the first three tones you heard." +  
        "<br><br>The three keys you can press throughout the experiment are '<b>p</b>', '<b>q</b>', and '<b>spacebar</b>'. " + 
        "Again, these are the only three keys that will register any response!" + 
      "<p>" + 
      "<div>",  
      post_trial_gap: 400, 
      choices: ["Let's go!"]
    };

    var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:120%; top:20%"></div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: function(){
        return jsPsych.randomization.sampleWithoutReplacement([1000, 1500], 1)[0];
      },
      data: {test_part: 'fixation'}
    }
    
		var train = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q'],
      trial_duration: acquisition_trial_duration,
      response_ends_trial: true, 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
  		}
    }
		var test = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q', 'space'],
      trial_duration: acquisition_trial_duration, 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response)
        console.log(data)
  		}
    }

    var feedback = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS, 
      trial_duration: 1000, 
      stimulus: function(){
      
        var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
        var stimulus = jsPsych.data.get().last(1).values()[0].stimulus
        var valence = jsPsych.data.get().last(1).values()[0].valence
        if (valence=='positive') {
          if (last_trial_correct){  
            return '<font size="100%"> + 0.01</font>';
          } else {
            return '<font size="100%"> + 0.00</font>'
          }
        } else if (valence=='negative') { 
          if (last_trial_correct){  
            return '<font size="100%"> - 0.00</font>';
          } else {
            return '<font size="100%"> - 0.01</font>'
          }
        } else {
          return '<font size="100%"></font>'
        }
      }
    }
    var generalization_trial_check = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS, 
      trial_duration: 1000, 
      stimulus: function(){
      
        var key_press = jsPsych.data.get().last(1).values()[0]['key_press'];
        if (key_press==null) {
          return "<p style='font-weight:bold; color: red; font-size=100%'> -$0.10 <br>RESPOND FASTER!</p>";
          data.penalty = 1
        } else {
          return '<font size="100%"></font>'
           data.penalty = 1       
        }
      }
    }


    var acquisition = {
      timeline: [fixation, train, feedback],
      timeline_variables: acquisition_stimuli,
      repetitions: acquisition_cycles,
      randomize_order: true
    }
 
    var generalization = {
      timeline: [fixation, test, generalization_trial_check],
      timeline_variables: generalization_stimuli,
      repetitions: 0,
      randomize_order: true
    }
    
    /* define debrief */
    var acquisition_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var positive_trials = jsPsych.data.get().filter({valence:'positive'}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 
        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        return 'so far your total bonus is $' + Math.max(0, positive_bonus - negative_bonus)
      }
    };
 

    /* define debrief */
    var generalization_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true}).count() 
        return 'bonus earned during this period: $' + (all_correct * bonus_amount)
      }
    };

    /* define debrief */
    var experiment_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
        
        var positive_trials = jsPsych.data.get().filter({valence:'positive', stage:'acquisition'}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 
        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative', stage:'acquisition'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        total_acquisition_bonus = Math.max(0, positive_bonus - negative_bonus)
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true}).count() 
        total_generalization_bonus = all_correct * bonus_amount

        total_bonus = total_generalization_bonus + total_acquisition_bonus
        return "That's it! Your total reward during this experiment was  $" + total_bonus
      }
    };
      
    
    /* CREATE TIMELINE */
    var timeline = [instructions, acquisition, acquisition_feedback,
                    generalization_instructions, generalization, generalization_feedback, 
                    experiment_feedback];
   

    /* start the experiment */
    jsPsych.init({
      preload_audio: audio, 
      use_webaudio: false,
			timeline: timeline,
      /*on_finish: function() {jsPsych.data.displayData();}*/
    });
  </script>
</html>
