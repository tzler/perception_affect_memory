<!DOCTYPE html>

<html>
  <head>
    <title>Auditory experiment</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  
  
    <!-- node libraries -->
    <script type="text/javascript" src="../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../node_modules/paper/dist/paper-full.js"></script>
  
  </head>

	<!-- BEGIN MTURK AND MONGO COMPATABILITY -->  
  <body>
    <!-- mturk compatability form -->
    <input type=hidden name='submit_data' id='submit_all_data'>
    <form name="hitForm" id="hitForm" method="POST" action="">
      <input type="hidden" name="assignmentId" id="assignmentId" value="">
      <input type='submit' name='submitButton' id='submitButton' value='Submit' class='submit_button'>
    </form>
  </body>
	 	<!--  custom javascript functions -->
	<script src='functions.js'></script>
  <!-- END MTURK AND MONGO COMPATABILITY -->
	
  <script> 

    // FUNCTIONS TO PLAY TONES ON INSTRUCTION SLIDE
    function play_low() { document.getElementById("low_audio").play() } 
    function play_high() { document.getElementById("high_audio").play(); } 
  
    /* EXPERIMENTAL PARAMETERS */ 
    var i_block = 0 
    var i_acquisition_trial = 0 
    var i_generalization_trial = 0
    var bonus_amount = 0.02
    var generalization_data = { stage: 'generalization', correct_response: 'space', valence: ''}
    var surround = [-100, -60, -20, -5, 5, 20, 60, 100] 
    var stimulus_folder = "sound/"    
    var generalization_stimuli = [] 
    var valence_tones = [300, 700] 
    var response_keys = ['p', 'q']
    var valence_types = ['positive', 'negative']
    var neutral_tones = [500] 
    var acquisition_trial_duration = 2500    
    var acquisition_cycles = 0
    var instrumental_prompt = '<div style="font-size:120%; bottom: 10px; font-weight:bold">For positive tones press "p" for negative tones press "q"</div>'
    var helpless_prompt = '<div style="font-size:120%; bottom: 10px; font-weight:bold">helpless</div>' 
    
    /* GENERATE DATA FILE FOR GENERALIZATION STAGE */
    for (i_valence=0;i_valence<valence_tones.length;i_valence++){ 
      /* ADD VALENCE TONES */ 
      generalization_stimuli.push({stimulus: stimulus_folder+ (valence_tones[i_valence]),
                                   data:{stage:'generalization', 
                                         correct_response:response_keys[i_valence], 
                                         valence: valence_types[i_valence]}})
      /* ADD SURROUND TONES */ 
      for (i_gen=0;i_gen<surround.length;i_gen++){ 
        generalization_stimuli.push({stimulus:stimulus_folder+ (valence_tones[i_valence] + surround[i_gen]), 
                                     data:generalization_data}) }}

    var positive_instrumental = {
      stimulus: stimulus_folder + valence_tones[0], 
      prompt: instrumental_prompt,
      data: { stage: 'acquisition', correct_response: 'p', valence: 'positive', condition: "instrumental"}
    };
    var negative_instrumental = {
      stimulus: stimulus_folder + valence_tones[1], 
      prompt: instrumental_prompt,
      data: { stage: 'acquisition', correct_response: 'q', valence: 'negative', condition: "instrumental"}
    };
    var neutral_instrumental = {
      stimulus: stimulus_folder + neutral_tones[0], 
      prompt: instrumental_prompt, 
      data: { stage: 'acquisition', correct_response: 'space', valence: 'neutral', condition: "instrumental" }
    };
    var positive_pavlovian = {
      stimulus: stimulus_folder + valence_tones[0], 
      prompt: helpless_prompt,
      data: { stage: 'acquisition', correct_response: 'p', valence: 'positive', condition: "pavlovian", correct: true} 
    };
    var negative_pavlovian = {
      stimulus: stimulus_folder + valence_tones[1], 
      prompt: helpless_prompt,
      data: { stage: 'acquisition', correct_response: 'q', valence: 'negative', condition: "pavlovian", correct: false}
    }
 
    /* GENERATE DATA FILE FOR THE ACQUISITION STAGE WITH THE RIGHT DISTRIBUTION THAT WE'LL PRESENT RANDOMLY*/
    var acquisition_stimuli = [
      positive_instrumental, positive_instrumental, negative_instrumental, negative_instrumental, neutral_instrumental, neutral_instrumental, positive_pavlovian, negative_pavlovian
    ];
    
    /* GENERATE AUDIO FILE FOR PRELOADING */
    var audio = [] 
    for (i=0;i<generalization_stimuli.length;i++)
      { audio.push(generalization_stimuli[i]['stimulus'])}
    for (i=0;i<acquisition_stimuli.length;i++)
      { audio.push(acquisition_stimuli[i]['stimulus'])}

    var instructions = {
      type:  "instructions", // "html-button-response",
      // read slide structure from HTML element
      pages:[ 
        
      "<div style='width:70%;transform:translateX(20%)'>"+
      "<p style='font-size:200%; font-weight:bold'>Welcome to our experiment!</p>" + 
        "<p style='font-size:140%'>In this study your goal is to learn how best to respond to different sounds.</p>"+ 
        "<p> " + 
          "You'll hear three sounds, and you'll have to respond differently to each one. " + 
          "For one sound, you'll have a small amount added to your bonus when you press the correct key</b>. " + 
          "We'll call this the 'positive' sound. " + 
          "For another sound you'll have a small amound taken away from your bonus when you press the incorrect key. " + 
          "We'll call this the 'negative' sound. " + 
          "For a the last sound, nothing will happen, and you don't have to press anything. " +  
        "</p>" + 
        "<p style='font-size:120%;'> " + 
          "Once you learn which key to press for each sound, you'll be able to gain bonus after the positive sound, and avoid loosing bonus after the negative sound. " +        
        "</p></div>", 
        "<div style='width:70%;transform:translateX(20%)'><p>" +  
          "<p style='font-size:200%; font-weight:'>Bonus and timing information</p>" +
          "<p> The two keys you'll use to respond to these sounds are <b>p</b> and <b>q</b>. " + 
            "When you press the correct key for the positive sound, you'll receive $" + bonus_amount  + ". If you are incorrect you wont receive any bonus. " +  
            "When you press the correct key for the negative sound, you wont loose any bonus. " + 
            "If you press the incorrect key, you'll have $" + bonus_amount + " taken away from your total bonus. " +  
            "<br><br>" + 
            "You'll have two seconds to respond to each sound. " + 
            "After each response, you'll receive feedback: the amount you earned or lost will be presented at the center of the screen." + 
            "If you dont respond in two seconds, you'll be marked as incorrect and--depending on the trial--you'll either loose bonus, or wont gain any bonus. " + 
            "</div>" ,  
        "<div style='width:70%;transform:translateX(20%)'> " + 
        "<audio id='low_audio'><source src='sound/100' type='audio/mpeg'></audio> " + 
        "<audio id='high_audio'><source src='sound/920' type='audio/mpeg'></audio> " + 
          "<p style='font-size:200%; font-weight:'>Testing the sound presentation</p>" +
        "<p> " + 
          "If you press the buttons below, you'll hear the kind of sounds that will be played throughout the experiment. " + 
        "</p> " +
        "<p> " +  
          "<button onclick='play_low()' type='button' style='padding:10px; margin:10px 100px' >SOUND EXAMPLE A</button> " + 
          "<button onclick='play_high()' type='button' style='padding:10px; margin:10px 100px' >SOUND EXAMPLE B</button> " +  
        "</p>" + 
        "<p>" + 
          "If you can't hear these two sounds, try turning up the volume. If that doesn't work, you shouldn't accept this HIT: " + 
          "<strong>If you can't hear these sounds, you wont be able to make any money in this experiment.</strong>"+ 
      "</div> ", 
      "<div style='width:70%;transform:translateX(20%)'>"+ 
        "<p style='font-size:150%'></p>" + 
        "<p>" + 
          "Between sounds, this will be a prompt on on the screen, reminding you which buttons to press. " + 
          "But sometimes, before you hear the next sound, you'll see this presented at the center of the screen:" + 
          "<br><br><br>" + 
        "<p style='font-weight:bold; font-size:120%'>helpless</p>" +  
        "<br>" + 
        "<p>" + 
          "When you see this, you don't need to respond. One of two things will happen. " + 
          "If a positive sound is played, $" + bonus_amount + " will be automatically added to the bonus you've earned--you don't need to press anything. " + 
          "If a negative sound is played, $" + bonus_amount + " will be taken away from the total bonus you've earned--you can't stop this." +  
        "<br>" +
        "</p>" + 
      "</div>",  
      "<div style='width:70%;transform:translateX(20%)'> " +
        "<br><br>" + 
        "We expect this HIT to take about 10 minutes. If you perform really well, you can earn over $3.00. " + 
        "Once the experiment starts it moves forward automatically, so you should only begin the HIT when you can focus on the task. " + 
        "Feel free to read over the instructions again if you're uncertain about anything. " + 
        "If you're ready to begin the experiment, click the button below to proceed."  +
        "<br><br>" 
        ], 
        
      show_clickable_nav: true,
      show_page_number: true, 
      post_trial_gap: 1000, 
      choices: ["<p style='margin: 10px'>I'm ready to start!</p>"],
      on_load: function(trial) {
        // modify HTML to include bonus amount
        $(".bonus_amount").html(bonus_amount, 'any arguments other than the first will be ignored');
      }
    };

    var generalization_instructions = {
      type: "html-button-response",
      stimulus: "<div style='width:70%;transform:translateX(20%)'>" + 
      "<p>" + 
        "<p style='font-size:140%'>Now the experiment is going to change just a bit.</p>" + 
        "We'll play a sound, and you'll have to decide if it was either the positive or negative sound in the last section. " + 
        "If it was, you should press the key that sound was associated with (e.g. 'p' or 'q'), and you'll be rewarded. " + 
        "If the sound you hear isn't the positive or negative tone, you'll press the '<b>space bar</b>'. " + 
        "<br><br>The three keys you can press throughout the experiment are '<b>p</b>', '<b>q</b>', and the '<b>spacebar</b>'. " + 
        "Again, these are the only three keys that will register any response!" + 
      "<p>" + 
      "<div>",  
      post_trial_gap: 400, 
      choices: ["Let's go!"]
    };

    var fixation = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS,
      stimulus: '<div style="font-size:120%; top:20%"></div>',
      trial_duration: 1000, 
      /*function(){
        return jsPsych.randomization.sampleWithoutReplacement([1000, 1500], 1)[0];
      },*/
      data: {test_part: 'fixation'},
      prompt: jsPsych.timelineVariable('prompt'),
    }
    
		var train = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q'],
      trial_duration: acquisition_trial_duration,
      response_ends_trial: false,
      post_trial_gap: 300, 
      prompt: jsPsych.timelineVariable('prompt'), 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        // if it's pavlovian, data.correct is already set
        if (data.condition == "instrumental") {
          data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
          data.i_acquisition_trial = i_acquisition_trial
          i_acquisition_trial = i_acquisition_trial + 1
        }
        data.i_block = i_block
        data.frequency = data.stimulus.slice(6, data.stimulus.length)
        save_trial_to_database(data)
      },
    }
		var test = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q', 'space'],
      trial_duration: acquisition_trial_duration, 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response)
  		  data.i_generalization_trial = i_generalization_trial
        i_generalization_trial = i_generalization_trial + 1
        data.i_block = i_block
        save_trial_to_database(data)
      }
    }

    var feedback = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000, 
      post_trial_gap: 500, 

      stimulus: function(){
      
        var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
        var stimulus = jsPsych.data.get().last(1).values()[0].stimulus
        var valence = jsPsych.data.get().last(1).values()[0].valence
        if (valence=='positive') {
          if (last_trial_correct){  
            return '<font size="100%" weight=bold> + $0.01 </font>';
          } else {
            return '<font size="100%" weight=bold> + $0.00 </font>'
          }
        } else if (valence=='negative') { 
          if (last_trial_correct){  
            return '<font size="100%" weight=bold> - $0.00 </font>';
          } else {
            return '<font size="100%" weight=bold> - $0.01 </font>'
          }
        } else {
          return '<font size="100%"></font>'
        }
      }
    }
    var generalization_trial_check = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS, 
      trial_duration: 1000, 
      stimulus: function(){
      
        var key_press = jsPsych.data.get().last(1).values()[0]['key_press'];
        if (key_press==null) {
          return "<p style='font-weight:bold; color: red; font-size=100%'> -$0.10 <br>RESPOND FASTER!</p>";
          data.penalty = 1
        } else {
          return '<font size="100%"></font>'
           data.penalty = 1       
        }
      }
    }


    var acquisition = {
      // for 2 out of every 10 of these should be "pavlovian":
      //    - fixation should say "helpless!"
      //    - for one of those two, trial should play negative tone and feedback should be negative
      //    - for the other, trial should play positive tone and feedback should be positive
      timeline: [fixation, train, feedback],
      // condition: "pavlovian" or "instrumental",
      timeline_variables: acquisition_stimuli,
      repetitions: acquisition_cycles,
      randomize_order: true,
      // could put something here.
    }
 
    var generalization = {
      timeline: [fixation, test, generalization_trial_check],
      timeline_variables: generalization_stimuli,
      repetitions: 0,
      randomize_order: true
    }
    
    /* define debrief */
    var acquisition_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var positive_trials = jsPsych.data.get().filter({valence:'positive'}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 
        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        return 'so far your total bonus is $' + Math.max(0, positive_bonus - negative_bonus).toFixed(2); 
      }
    };
 

    /* define debrief */
    var generalization_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true}).count() 
        return 'bonus earned during this period: $' + (all_correct * bonus_amount)
      }
    };

    /* define debrief */
    var experiment_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
        
        var positive_trials = jsPsych.data.get().filter({valence:'positive', stage:'acquisition'}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 
        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative', stage:'acquisition'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        total_acquisition_bonus = Math.max(0, positive_bonus - negative_bonus)
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true}).count() 
        total_generalization_bonus = all_correct * bonus_amount

        total_bonus = total_generalization_bonus + total_acquisition_bonus
        return "That's it! Your total reward during this experiment was  $" + total_bonus
      }
    };
      
    
    /* CREATE TIMELINE */
    var timeline = [instructions, acquisition, acquisition_feedback,
                    generalization_instructions, generalization, generalization_feedback, 
                    experiment_feedback];
   

    /* start the experiment */
    jsPsych.init({
      preload_audio: audio, 
      use_webaudio: false,
			timeline: timeline,
      /*on_finish: function() {jsPsych.data.displayData();}*/
    });
  
  </script>
</html>
