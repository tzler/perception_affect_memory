<!DOCTYPE html>

<html>
  <head>
    <title>Auditory experiment</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
    <!-- node libraries -->
    <script type="text/javascript" src="../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../node_modules/paper/dist/paper-full.js"></script>
  </head>
  
  <script> 
    
    // FUNCTIONS TO PLAY TONES ON INSTRUCTION SLIDE
    function play_low() { document.getElementById("low_audio").play() } 
    function play_high() { document.getElementById("high_audio").play(); } 
  
    /* EXPERIMENTAL PARAMETERS */ 
    var i_block = 0 
    var i_acquisition_trial = 0 
    var i_generalization_trial = 0
    var bonus_amount = 0.02
    var generalization_bonus_amount = 0.02
    var generalization_data = { stage: 'generalization', correct_response: 'space', valence: ''}
    
    var tone_balance = 1*(Math.random()>0.5);
    var two_tones = [300, 700] 
    var valence_tones = [two_tones[tone_balance], two_tones[1*(!tone_balance)]]
    
    var demo = 1
    if (demo){
      var surround = [-100, -20]
      var randos = [] 
      var n_repeats_of_original = 1
      var acquisition_cycyles = 0
      var generalization_cycles = 0
      console.log('experiment in demo version')
    } else {
      var surround = [-100, -20, -5, 5, 20, 100]
      var randos = [480, 500, 520, 880, 900, 920] 
      var n_repeats_of_original = 3
      var acquisition_cycles = 3
      var generalization_cycles = 0 
      console.log('experiment not in demo version')
    }
    
    var stimulus_folder = "sound/"    
    var generalization_stimuli = [] 
    var key_balance = 1*(Math.random()>0.5);
    var two_keys = ['p', 'q'] 
    var response_keys = [ two_keys[key_balance], two_keys[1*(!key_balance)]]
    var response_keys = two_keys
    var valence_types = ['positive', 'negative']
    var neutral_tones = [500] 
    var acquisition_trial_duration = 2500    
    var instrumental_prompt = "<div style='font-size:120%; bottom: 10px; font-weight:bold'>Press either 'p' or 'q' to increase your bonus (positive) or avoid loosing it (negative)</div>"
    var helpless_prompt = "<div style='font-size:120%; bottom: 10px; font-weight:bold'>helpless</div>" 
    var generalization_prompt = "<div style='font-size:120%; bottom: 10px; font-weight:bold'>If you hear the positive or negative tone, press the button associated with it (either 'p' or 'q')<br><br>Otherwise press the space bar.</div>" 


    /* GENERATE DATA FILE FOR GENERALIZATION STAGE */
    for (i_valence=0;i_valence<valence_tones.length;i_valence++){ 
      /* ADD VALENCE TONES -- currently 12.5% -- 14% in the paper */ 
      for(i_originals=0;i_originals<n_repeats_of_original;i_originals++){
          generalization_stimuli.push({ stimulus: stimulus_folder+ (valence_tones[i_valence]),
                                        data:{ stage:'generalization', 
                                               correct_response:response_keys[i_valence], 
                                               valence: valence_types[i_valence]}, 
                                        prompt: generalization_prompt, 
                                        distance: 0
          })
      }
      /* ADD SURROUND TONES -- currently 25% -- 29% in the paper */ 
      for (i_gen=0;i_gen<surround.length;i_gen++){ 
        generalization_stimuli.push({ stimulus:stimulus_folder + (valence_tones[i_valence] + surround[i_gen]), 
                                      data: { stage:'generalization',
                                              correct_response:'space',
                                              valence:valence_types[i_valence]},  
                                      prompt: generalization_prompt, 
                                      distance: surround[i_gen]
        }) 
      }
    }
    /* ADD RANDO TONES -- removed everything around 100*/
    for (i_ran=0;i_ran<randos.length;i_ran++){
      generalization_stimuli.push({ stimulus: stimulus_folder + randos[i_ran], 
                                    data: { stage:'generalization', 
                                            correct_response:'space', 
                                            valence:'control'}, 
                                    prompt: generalization_prompt
      })
    }
    var positive_instrumental = {
      stimulus: stimulus_folder + valence_tones[0], 
      prompt: instrumental_prompt,
      data: { stage: 'acquisition', correct_response: 'p', valence: 'positive', condition: "instrumental"}
    };
    var negative_instrumental = {
      stimulus: stimulus_folder + valence_tones[1], 
      prompt: instrumental_prompt,
      data: { stage: 'acquisition', correct_response: 'q', valence: 'negative', condition: "instrumental"}
    };
    var neutral_instrumental = {
      stimulus: stimulus_folder + neutral_tones[0], 
      prompt: instrumental_prompt, 
      data: { stage: 'acquisition', correct_response: 'space', valence: 'neutral', condition: "instrumental" }
    };
    var positive_pavlovian = {
      stimulus: stimulus_folder + valence_tones[0], 
      prompt: helpless_prompt,
      data: { stage: 'acquisition', correct_response: 'p', valence: 'positive', condition: "pavlovian", correct: true} 
    };
    var negative_pavlovian = {
      stimulus: stimulus_folder + valence_tones[1], 
      prompt: helpless_prompt,
      data: { stage: 'acquisition', correct_response: 'q', valence: 'negative', condition: "pavlovian", correct: false}
    }
    
    if (demo) {
      var acquisition_stimuli = [positive_instrumental, 
                                 negative_instrumental, 
                                 positive_pavlovian, 
                                 negative_pavlovian, 
                                 neutral_instrumental]                           
    } else {  
      /* GENERATE DATA FOR THE ACQUISITION STAGE */
      var acquisition_stimuli = [
        /* 27% -- should be 25% */
        positive_instrumental, positive_instrumental, positive_instrumental, 
        /* 27% -- should be 25% */
        negative_instrumental, negative_instrumental, negative_instrumental,
        /* 27% -- should be 33% */
        neutral_instrumental, neutral_instrumental, neutral_instrumental,  
        /*  9% -- should be 10% */
        positive_pavlovian, negative_pavlovian 
      ];
    }                                      
    /* GENERATE AUDIO FILE FOR PRELOADING */
    var audio = [] 
    for (i=0;i<generalization_stimuli.length;i++)
      { audio.push(generalization_stimuli[i]['stimulus'])}
    for (i=0;i<acquisition_stimuli.length;i++)
      { audio.push(acquisition_stimuli[i]['stimulus'])}

    var instructions = {
      type:  "instructions", // "html-button-response",
      // read slide structure from HTML element
      pages:[ 
        
      "<div style='width:70%;transform:translateX(20%)'>"+
      "<p style='font-size:200%; font-weight:bold'>Welcome to our experiment!</p>" + 
        "<p style='font-size:120%'>We're interested how people learn to respond in different ways to new sounds.</p>"+ 
      "<p>The bonus you receive for this HIT will depend on your performance; make sure you understand the instructions before moving on, or you wont earn any bonus!" +   
      "</p>", 
      "<div style='width:70%;transform:translateX(20%)'>"+
        "<p> " + 
        "<p style='font-size:160%'>There will be three kinds of sounds, which will all sound differently:<br></p>" + 
          "<p><b>1) A Positive sound</b>: This is the only sound you'll earn money from. " + 
          "When you hear this sound, you'll have a small amount added to your bonus when you press the correct key; if you press the incorrect key you'll gain nothing.<p> " + 
          "<p><b>2) A Negative sound</b>: This is the only sound you'll lose money from. " + 
          "When you hear this sound, you'll have a small amount removed from your bonus if you press the incorrect key; if you press the correct key you'll loose nothing.<p>" + 
          "<p><b>3) A Neutral sound</b>: Nothing will happen when you hear this sound--you wont loose or gain money. Don't respond.</p></div>",  
        "<p style='font-size:140%'>You'll have to learn the correct key to press for the positive and negative sounds.</p>", 
        "<div style='width:70%;transform:translateX(20%)'><p>" +  
          "<p style='font-size:160%; '>When you hear a sound, you can respond by pressing either '<b>p</b>' or '<b>q</b>'</p>" + 
          "<p>When you hear the positive sound and press the correct key (either 'p' or 'q'), you'll receive $" + bonus_amount  + ". If you are incorrect you wont receive any bonus. " +  
            "When you hear the negative sound and press the correct key (either 'q' or 'p') you wont loose any bonus. " + 
            "But if you press the incorrect key for the negative sound, you'll have $" + bonus_amount + " taken away from your total bonus. " +  
            "<br><br></div>",  
         "<div style='width:70%;transform:translateX(20%)'>" +  
        "<p style='font-size:160%'>You'll have two seconds to respond to each sound</p> " + 
            "After each response, you'll receive feedback: the amount you earned or lost will be presented at the center of the screen. " + 
            "If you dont respond in two seconds, you'll be marked as incorrect and--depending on the trial--you'll either loose bonus, or wont gain any bonus. " + 
            "<br><br></div>" ,  

    "<div style='width:70%;transform:translateX(20%)'>"+ 
        "<p style='font-size:150%'>Sometimes you wont be able to respond</p>" + 
        "<p>" + 
          "Between sounds, this will usually be a prompt on on the screen, reminding you which buttons to press. " + 
          "But sometimes, before you hear the next sound, you'll see this presented at the center of the screen:" + 
          "<br><br><br>" + 
        "<p style='font-weight:bold; font-size:120%'>helpless</p>" +  
        "<br>" + 
        "<p>" + 
          "When you see this, you wont be able to respond. One of two things will happen: " + 
          "If a positive sound is played, you'll gain money. If a negative sound is played, you'll loose money."+ 
        "<br>" +
        "</p>" + 
      "</div>",  
      "<div style='width:70%;transform:translateX(20%)'> " + 
        "<audio id='low_audio'><source src='sound/200' type='audio/mpeg'></audio> " + 
        "<audio id='high_audio'><source src='sound/920' type='audio/mpeg'></audio> " + 
        "<p style='font-size:200%; font-weight:'>Testing the sound presentation</p>" +
        "<p> " + 
          "If you press the buttons below, you'll hear the kind of sounds that will be played throughout the experiment. " + 
        "</p> " +
        "<p> " +  
          "<button onclick='play_low()' type='button' style='padding:10px; margin:10px 100px' >SOUND EXAMPLE A</button> " + 
          "<button onclick='play_high()' type='button' style='padding:10px; margin:10px 100px' >SOUND EXAMPLE B</button> " +  
        "</p>" + 
        "<p> If you can't hear these two sounds, try turning up the volume. If that doesn't work, you return this HIT</p>" + 
      "</div> ", 

      "<div style='width:70%;transform:translateX(20%)'> " +
        "<br><br>" + 
        "We expect this HIT to take about 10 minutes. If you perform really well, you can earn over $3.00. " + 
        "Once the experiment starts it moves forward automatically, so you should only begin the HIT when you can focus on the task. " + 
        "Feel free to read over the instructions again if you're uncertain about anything. " + 
        "If you're ready to begin the experiment, click the button below to proceed."  +
        "<br><br>" 
        ], 
        
      show_clickable_nav: true,
      show_page_number: true, 
      post_trial_gap: 1000, 
      choices: ["<p style='margin: 10px'>I'm ready to start!</p>"],
      on_load: function(trial) {
        // modify HTML to include bonus amount
        $(".bonus_amount").html(bonus_amount, 'any arguments other than the first will be ignored');
      }
    };

    var generalization_instructions = {
      type: "instructions",
      pages: ["<div style='width:70%;transform:translateX(20%)'>" + 
      "<p>" + 
        "<p style='font-size:140%'>Now you'll begin the second part of the experiment, which is different from the first.</p>" + 
        "<p>We'll play a sound, and you'll have to decide if it was either the positive or negative sound in the last section.</p>" + 
        "If it was, you should press the key that sound was associated with (either 'p' or 'q'). " + 
        "If the sound you hear isn't the positive or negative tone (it's new) you'll press the '<b>space bar</b>'. " + 
        "Every time you get the answer right you'll receive a bonus of $" + generalization_bonus_amount + "</p></div>", 
      "<div style='width:70%;transform:translateX(20%)'><p>" + 
        "You wont loose money by getting an answer wrong, but you will loose A LOT of money ($0.20) if you don't respond within 2 seconds. " + 
        "If you take too long, red words will flash on the screen telling you to respond faster. " + 
        "Otherwise, there's no feedback after each response (it's not like the last part); " + 
        "instead we'll tell you how much bonus you earned at the end of this stage.</p></div>", 
      "<div style='width:70%;transform:translateX(20%)'><p>" +
       "Again the three keys you can press throughout the experiment are '<b>p</b>', '<b>q</b>', and the '<b>spacebar</b>'. " + 
       "If you hear the positive or negative sound from the first part of the experiment, press the key (either 'p' or 'q') associated with it. " + 
       "If it's a new sound, press the spacebar." +  
       "Respond quickly, to avoid loosing your bonus, and the more accurate you are, the more bonus you'll earn! " + 
      "<p>" + 
      "<div>"],  
      post_trial_gap: 400,
      show_clickable_nav: true,
      show_page_number: true, 
      choices: ["Let's go!"]
    };

    var acquisition_return_instructions = {
      type: "instructions",
      pages: ["<div style='width:70%;transform:translateX(20%)'>" + 
      "<p>" + 
        "<p style='font-size:140%'>Now we're going to go back to the first part of the experiment.</p>" + 
        "<p>The sounds and keys (either 'p' or 'q') will be the same; for the positive sound press the correct key to earn more money, for the negative sound press the correct key to avoid loosing money." + 
        "The more accurate you are, the more bonus you'll earn! " + 
      "<p>" + 
      "<div>"],  
      post_trial_gap: 400,
      on_load: function(){i_block=i_block + 1},  
      show_clickable_nav: true,
      show_page_number: true, 
      choices: ["Let's go!"]
    };

    var generalization_return_instructions = {
      type: "instructions",
      pages: ["<div style='width:70%;transform:translateX(20%)'>" + 
      "<p>" + 
        "<p style='font-size:140%'>Now we're going to go back to the second part of the experiment.</p>" + 
        "<p>If the tone you hear is the positive sound, press 'p'. If the tone you hear is the negative sound, press 'q'. Otherwise, press the space bar." + 
        "The more accurate you are, the more bonus you'll earn! " + 
      "<p>" + 
      "<div>"],  
      post_trial_gap: 400,
      show_clickable_nav: true,
      show_page_number: true, 
      choices: ["Let's go!"]
    };


    var fixation = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS,
      stimulus: '<div style="font-size:120%; top:20%"></div>',
      trial_duration: 1000, 
      data: {test_part: 'fixation'},
      prompt: jsPsych.timelineVariable('prompt'),
    }
   
    var generalization_reminder = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS,
      stimulus: '<div style="font-size:120%; top:20%"></div>',
      trial_duration: 1000, 
      data: {test_part: 'fixation'},
      prompt: jsPsych.timelineVariable('prompt'),

  }
    
		var train = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q'],
      trial_duration: acquisition_trial_duration,
      response_ends_trial: false,
      post_trial_gap: 300, 
      prompt: jsPsych.timelineVariable('prompt'), 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        // if it's pavlovian, data.correct is already set
        if (data.condition == "instrumental") {
          data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
          data.i_acquisition_trial = i_acquisition_trial
          i_acquisition_trial = i_acquisition_trial + 1
        }
        data.i_block = i_block
        data.frequency = data.stimulus.slice(6, data.stimulus.length)
        save_trial_to_database(data)
      },
    }
		var test = {
      type: "audio-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'), 
      choices: ['p', 'q', 'space'],
      trial_duration: acquisition_trial_duration, 
      response_ends_trial: false,
      prompt: jsPsych.timelineVariable('prompt'), 
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response)
  		  data.i_generalization_trial = i_generalization_trial
        i_generalization_trial = i_generalization_trial + 1
        data.i_block = i_block
        save_trial_to_database(data)
      }
    }
    console.log(document.getElementById('assignmentId'))
    var feedback = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000, 
      post_trial_gap: 500, 

      stimulus: function(){
      
        var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
        var stimulus = jsPsych.data.get().last(1).values()[0].stimulus
        var valence = jsPsych.data.get().last(1).values()[0].valence
        if (valence=='positive') {
          if (last_trial_correct){  
            return '<font size="100%" weight=bold> + $0.01 </font>';
          } else {
            return '<font size="100%" weight=bold> + $0.00 </font>'
          }
        } else if (valence=='negative') { 
          if (last_trial_correct){  
            return '<font size="100%" weight=bold> - $0.00 </font>';
          } else {
            return '<font size="100%" weight=bold> - $0.01 </font>'
          }
        } else {
          return '<font size="100%"></font>'
        }
      }
    }
    var generalization_trial_check = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS, 
      trial_duration: 1000, 
      stimulus: function(){
      
        var key_press = jsPsych.data.get().last(1).values()[0]['key_press'];
        if (key_press==null) {
          return "<p style='font-weight:bold; color: red; font-size=100%'> - $" + (bonus_amount  * 10).toFixed(2) + "<br>RESPOND FASTER!</p>";
          data.penalty = 1
        } else {
          return generalization_prompt
           data.penalty = 0 
        }
      }
    }


    var acquisition = {
      // for 2 out of every 10 of these should be "pavlovian":
      //    - fixation should say "helpless!"
      //    - for one of those two, trial should play negative tone and feedback should be negative
      //    - for the other, trial should play positive tone and feedback should be positive
      timeline: [fixation, train, feedback],
      // condition: "pavlovian" or "instrumental",
      timeline_variables: acquisition_stimuli,
      repetitions: acquisition_cycles,
      randomize_order: true,
      // could put something here.
    }
 
    var generalization = {
      timeline: [generalization_reminder, test, generalization_trial_check],
      timeline_variables: generalization_stimuli,
      repetitions: generalization_cycles,
      randomize_order: true
    }
    
    /* define debrief */
    var acquisition_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var positive_trials = jsPsych.data.get().filter({valence:'positive', i_block:i_block}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 
        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        return "The total bonus amount of bonus you earned in this last period was $" + Math.max(0, positive_bonus - negative_bonus).toFixed(2) + 
        ".<br> Press any button to continue to the next step."
      }
    };
 

    /* define debrief */
    var generalization_feedback = {
      type: "html-keyboard-response",
      
      stimulus: function() {
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true, i_block:i_block}).count() 
        return 'bonus earned during this period: $' + (all_correct * bonus_amount)
      }
    };

    /* define debrief */
    var experiment_feedback = {
      type: 'html-keyboard-response',
      
      stimulus: function() {
        
        var positive_trials = jsPsych.data.get().filter({valence:'positive', stage:'acquisition'}) 
        var positive_correct = positive_trials.filter({correct: true});
        var positive_accuracy = positive_correct.count() / positive_trials.count()
        var positive_bonus = positive_correct.count() * bonus_amount 

        console.log('positive bonus:', positive_bonus) 
        var negative_trials = jsPsych.data.get().filter({valence:'negative', stage:'acquisition'}) 
        var negative_correct = negative_trials.filter({correct: true});
        var negative_accuracy = negative_correct.count() / negative_trials.count()
        var negative_bonus = ( negative_trials.count() - negative_correct.count() )  * bonus_amount
        console.log('negative bonus:', negative_bonus)
        total_acquisition_bonus = Math.max(0, positive_bonus - negative_bonus)
      
        var all_correct = jsPsych.data.get().filter({stage:'generalization', correct:true}).count() 
        total_generalization_bonus = all_correct * bonus_amount

        return "That's it--you're done! Your total reward during this experiment was  $" + (total_acquisition_bonus + total_generalization_bonus).toFixed(2)  + " <br>Press any key to continue." 
      },
      on_load: function() { 

        } 
    };
      
    var exit_slide = {
      type: 'instructions', 
      stimulus:'thats it!', 
      on_start: function(){ $('#hidden_submit').show() }

    }

    /* CREATE TIMELINE */
    var timeline = [
                    /* INITIAL INSTRUCTIONS */ 
                    instructions, 
                    
                    /* FIRST ACQUISITION BLOCK */ 
                    acquisition, 
                    acquisition_feedback, 
                  
                    /* FIRST GENERALIZATION BLOCK */ 
                    generalization_instructions,
                    generalization,
                    generalization_feedback,
                    
                    /* SECOND ACQUISITION BLOCK */ 
                    acquisition_return_instructions, 
                    acquisition,  
                    acquisition_feedback,
                    
                    /* SECOND GENERALIZATION BLOCK */ 
                    generalization_return_instructions, 
                    generalization, 
                    generalization_feedback,

                    /* ACQUISITION BLOCK */ 
                    acquisition_return_instructions, 
                    acquisition,  
                    acquisition_feedback, 

                    /* LAST GENERALIZATION BLOCK */
                    generalization_return_instructions, 
                    generalization, 
                    generalization_feedback,
 
                    /* EXPERIMENT SUMMARY */
                    experiment_feedback,
    ];
   

    /* start the experiment */
    jsPsych.init({
      preload_audio: audio, 
      use_webaudio: false,
			timeline: timeline,
      on_finish: function() {
        $('#hidden_submit').show()
      }
    });
  </script>

	<!-- BEGIN MTURK AND MONGO COMPATABILITY -->  
  <body>
    <!-- mturk compatability form -->
    <div id='hidden_submit' style='display:none; position: absolute; top:50%; left: 50%;; padding: 10px background:grey'> 
    <form name="hitForm" id="hitForm" method="POST" action=""> 
      <input type="hidden" name="assignmentId" id="assignmentId" value="">
      <input type='submit' name='submitButton' id='submitButton' value='Submit' class='submit_button'>
    </form>
  </body>
	 	<!--  custom javascript functions -->
	<script src='functions.js'></script>
  <!-- END MTURK AND MONGO COMPATABILITY -->

</html>
